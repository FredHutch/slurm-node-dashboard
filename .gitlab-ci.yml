variables:
  CI_DEBUG_SERVICES: "true"
  DOCKER_DRIVER: "overlay2"   # helpful but not sufficient without the --storage-driver above
  DOCKER_BUILDKIT: "1"

services:
  - name: docker:25.0.3-dind
    command:
      - "--data-root=/dind" #  # avoid any host bind at /var/lib/docker
      # Prefer overlay2; if your runner kernel lacks overlayfs, switch to --storage-driver=vfs
      - "--storage-driver=overlay2"


before_script:
  - apk update
  - apk --no-cache add py3-pip python3 curl
  - python3 -m venv $HOME/.venv
  - export PATH=$HOME/.venv/bin:$PATH
  - pip3 install pyyaml
  - curl -O https://raw.githubusercontent.com/FredHutch/swarm-build-helper/main/build_helper.py
  # below is from https://stackoverflow.com/a/65810302/470769
  - mkdir -p $HOME/.docker
  - echo $DOCKER_AUTH_CONFIG > $HOME/.docker/config.json
  - set -x
  - docker version
  - docker info | sed -n 's/^Storage Driver: //p'


stages:
  - build
  - test
  - deploy

build:
  stage: build
  script:
    - echo $DOTENV_FILE_CONTENTS | base64 -d > .env
    - docker build --no-cache -t sc-registry.fredhutch.org/slurm-node-dashboard:test .
    - docker push sc-registry.fredhutch.org/slurm-node-dashboard:test

test:
  stage: test
  services:
    - name: sc-registry.fredhutch.org/slurm-node-dashboard:test
      alias: slurm-node-dashboard
  script:
    - sleep 15 && curl -sI  http://slurm-node-dashboard:3000  |head -1|grep -q "200 OK"

deploy:
  stage: deploy
  only:
    refs:
        - main
  script:
    - docker tag sc-registry.fredhutch.org/slurm-node-dashboard:test sc-registry.fredhutch.org/slurm-node-dashboard:latest
    - docker push sc-registry.fredhutch.org/slurm-node-dashboard:latest
    - sleep 15
    - echo $SC_SWARM_CICD_SSH_KEY | base64 -d > ./sc_swarm_cicd_ssh_key
    - chmod 0400 ./sc_swarm_cicd_ssh_key
    - python3 build_helper.py docker-compose.yml | ssh -i ./sc_swarm_cicd_ssh_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@sc-swarm-mgr.fhcrc.org docker stack deploy --with-registry-auth -c - slurm-node-dashboard
